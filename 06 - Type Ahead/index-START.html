<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Type Ahead ğŸ‘€</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>


  <!-- autocomplete="off"  è®“é»é¸å¾Œä¸è¦æœ‰browser cookie ç”¢ç”Ÿçš„ autocomplete -->
  <form class="search-form">
    <input type="text" class="search" autocomplete="off" id="search" placeholder="City or State">
    <ul class="suggestions">
      <!-- <li class="active">Filter for a city</li>
      <li>or a state</li> -->
    </ul>
  </form>
  <script>
    const endpoint =
      'https://gist.githubusercontent.com/Miserlou/c5cd8364bf9b2420bb29/raw/2bf258763cdddd704f8ffd3ea9a3e81d25e2c6f6/cities.json';

    const cities = [];

    fetch(endpoint)
      .then(res => res.json())
      .then(data => cities.push(...data));

    function findMatches(wordToMatch, cities) {
      return cities.filter(el => {
        return el.city.match(wordToMatch) || el.state.match(wordToMatch);
      })
    }

    //ä¸‰å€‹ä½æ•¸åŠ ä¸€å€‹,
    function numberWithCommas(number) {
      return number.replace(/\B(?=(?:\d{3})+\b)/g, ',');
    }


    let resultData = [];

    function displayMatches() {
      if (this.value == '') return false;
      let top10 = [];
      let reg = new RegExp(this.value, 'gi');
      resultData = findMatches(reg, cities);

      //æœ€å¤šé¡¯ç¤ºå‰10ç­†
      if (resultData.length > 10) {
        for (let i = 0; i < 10; i++) {
          top10.push(resultData[i]);
        }
      } else {
        for (let i = 0; i < resultData.length; i++) {
          top10.push(resultData[i]);
        }
      }

      let html = top10.map(item => {
        const cityName = item.city.replace(reg, `<span class="hl">${reg}</span>`);
        const stateName = item.state.replace(reg, `<span class="hl">${reg}</span>`);
        return `<li>
        <span class="name">${ cityName},${stateName}</span>
        <span  class="population">${ numberWithCommas(item.population)}</span>
        </li>`
      }).join('');
      suggestions.innerHTML = html;



    };

    let listIndex = -1;

    function handleList(e) {
      //å»é ­å°¾ç©ºç™½
      let value = this.value.replace(/^\s+|\s+$/g, "")
      if (value === '') return;

      let reGet = document.querySelector('.suggestions');
      let liList = reGet.querySelectorAll('li');

      switch (e.keyCode) {
        case 40:   // ä¸Šçš„æŒ‰éˆ•
          listIndex >= (liList.length - 1) ? listIndex = liList.length - 1 : listIndex++;
          break;
        case 38:  // ä¸‹çš„æŒ‰éˆ•
          listIndex <= 0 ? ã€€listIndex = 0 : ã€€listIndex--;
          break;
        default:  //ä¸ç®¡æŒ‰ä»»ä½•éµ éƒ½æœƒé‡æ–°ç”¢ç”Ÿactive
         listIndex = -1;    
        
       
      }

      if (listIndex >= 0 && liList.length >0) {
        liList.forEach(el => el.classList.remove('active'));
        liList.item(listIndex).classList.add('active');
      }

      if (e.keyCode == 13) {
        getSelectValue(liList);
      }

    };

    //enter æ‹¿ active çš„å€¼
    function getSelectValue(arr) {
      if(arr.length ==0) return;
      let value;
      arr.forEach(el => {
        if(el.classList.contains('active')){
          value =  el;
        }
      });
      searchInput.value =  value.querySelector('.name').textContent;
      suggestions.innerHTML = '';
    
    }

 

    let searchInput = document.querySelector('.search');
    let suggestions = document.querySelector('.suggestions');
    let searchForm = document.querySelector('.search-form');

    searchInput.addEventListener('input', displayMatches);
    searchInput.addEventListener('keydown', handleList);
    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
    });


    //é»é¸ä¸‹æ–¹åˆ—è¡¨ï¼Œå°‡æ•¸å€¼çµ¦input 
    suggestions.addEventListener('click', (e)=>{
     
      let value;
     if(e.target.nodeName != "LI") return;
     value = e.target.querySelector('.name').textContent
     searchInput.value = value;
     //æ¸…é™¤ä¸‹æ–¹ç”¢ç”Ÿçš„list
     suggestions.innerHTML = '';
     //é‡æ–°é¡¯ç¤ºactive
     listIndex = -1;
    })
  </script>
</body>

</html>